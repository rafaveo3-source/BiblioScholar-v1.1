<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fafaf9">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BiblioScholar">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>BiblioScholar App</title>

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2378350f%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23fafaf9%22 rx=%224%22/><path d=%22M20.24 12.24a6 1.21 0 0 0-3.58-6 9.19 9.19 0 0 0-8.8 8.8C7.84 15.06 5.3 18 3 21c2.8-1 6.36-2.46 9.42-2.14a24.18 24.18 0 0 0 5.68-4.78 4 4 0 0 0 .5-1.54 2.22 2.22 0 0 1 1.64-.3z%22/><line x1=%227.86%22 y1=%2215.04%22 x2=%2213.5%22 y2=%229.4%22/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2378350f%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23fafaf9%22 rx=%224%22/><path d=%22M20.24 12.24a6 1.21 0 0 0-3.58-6 9.19 9.19 0 0 0-8.8 8.8C7.84 15.06 5.3 18 3 21c2.8-1 6.36-2.46 9.42-2.14a24.18 24.18 0 0 0 5.68-4.78 4 4 0 0 0 .5-1.54 2.22 2.22 0 0 1 1.64-.3z%22/><line x1=%227.86%22 y1=%2215.04%22 x2=%2213.5%22 y2=%229.4%22/></svg>">

    <!-- Fonts & Libs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fixed Marked Version -->
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/lucide@latest"></script>

    <!-- PWA Manifest Injection -->
    <script>
        const manifest = {
            "name": "BiblioScholar",
            "short_name": "BiblioScholar",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#fafaf9",
            "theme_color": "#fafaf9",
            "icons": [{
                "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2378350f%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23fafaf9%22 rx=%224%22/><path d=%22M20.24 12.24a6 1.21 0 0 0-3.58-6 9.19 9.19 0 0 0-8.8 8.8C7.84 15.06 5.3 18 3 21c2.8-1 6.36-2.46 9.42-2.14a24.18 24.18 0 0 0 5.68-4.78 4 4 0 0 0 .5-1.54 2.22 2.22 0 0 1 1.64-.3z%22/><line x1=%227.86%22 y1=%2215.04%22 x2=%2213.5%22 y2=%229.4%22/></svg>",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }]
        };
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
        document.head.appendChild(link);
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>

    <style>
        /* Mobile Scroll Fixes */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            background-color: #fafaf9; 
            color: #1c1917; 
            -webkit-font-smoothing: antialiased; 
            overflow: hidden; /* Prevent body scroll, handle inside #root */
        }
        
        #root { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }

        .font-serif { font-family: 'Playfair Display', serif; }
        
        /* Markdown */
        .markdown-body h1, .markdown-body h2 { color: #78350f; margin-top: 1em; font-family: 'Playfair Display', serif; font-weight: 700; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body strong { color: #78350f; }
        .markdown-body blockquote { border-left: 3px solid #d6d3d1; padding-left: 1em; font-style: italic; color: #57534e; background: #f5f5f4; padding: 0.5em; }
        .markdown-body a { color: #b45309; text-decoration: underline; font-weight: bold; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; height: 6px; width: 6px; border-radius: 50%; background-color: #a8a29e; display: inline-block; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .has-note { text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #b45309; background-color: #fffbeb; }
        
        /* Safe Area Padding */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        /* Custom Scrollbar */
        .custom-scroll { 
            -webkit-overflow-scrolling: touch; /* Critical for iOS smooth scroll */
            overflow-y: auto;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #d6d3d1; border-radius: 20px; }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #78350f;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e7e5e4;
            border-radius: 2px;
        }

        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const renderer = new marked.Renderer();
        const linkRenderer = renderer.link;
        renderer.link = (href, title, text) => {
            const html = linkRenderer.call(renderer, href, title, text);
            return html.replace(/^<a /, '<a target="_blank" rel="noopener noreferrer" ');
        };
        marked.setOptions({ renderer });

        const SYSTEM_PROMPT_TEMPLATE = `
**PERFIL DO ALUNO:**
- Nome: {{USERNAME}}
- N√≠vel: {{LEVEL}}
- Interesse: {{INTEREST}}
- Objetivo: {{GOAL}}

**DIRETRIZES PRINCIPAIS:**
Voc√™ √© um erudito em Estudos B√≠blicos e um Mentor Espiritual. Seu objetivo √© guiar o usu√°rio em uma jornada de descoberta profunda, utilizando o **M√©todo Indutivo** (Observa√ß√£o, Interpreta√ß√£o e Aplica√ß√£o) e a **Intelig√™ncia Hist√≥rico-Geogr√°fica**.

**SEUS 5 PAP√âIS DE ATUA√á√ÉO:**
1. **O Cronologista:** Situe sempre o texto na ordem cronol√≥gica real.
2. **O Arque√≥logo Forense:** Busque o *artefato espec√≠fico*.
3. **O Te√≥logo da Unidade (Tipologia):** Mostre o "Fio Vermelho".
4. **O Linguista Comparativo:** Compare tradu√ß√µes.
5. **O Mentor Indutivo:** Ensine a observar, marcar e questionar.

**INSTRU√á√ïES DE RECURSOS VISUAIS:**
* **[Imagens/Mapas/Artefatos]:** Gere LINKS DE BUSCA Markdown: [üîç Ver Imagem: T√≠tulo](https://www.google.com/search?tbm=isch&q=T√≠tulo+Contexto+Biblico)
* **V√≠deos:** [‚ñ∂Ô∏è Assistir V√≠deo](https://www.youtube.com/results?search_query=Tema+Biblico+PT+BR)

**FORMATO DE RESPOSTA:**
1. Manchete.
2. Palco da Hist√≥ria.
3. Mergulho no Texto.
4. Elo Tipol√≥gico.
5. Dica de Marca√ß√£o.
6. A Ponte.
7. Curadoria.
8. Pr√≥ximo Passo.
`;

        const DataManager = {
            getUsers: () => JSON.parse(localStorage.getItem('bs_users') || '{}'),
            saveUser: (username, password) => {
                const users = DataManager.getUsers();
                if (users[username]) return false;
                users[username] = { username, password, profile: null };
                localStorage.setItem('bs_users', JSON.stringify(users));
                return users[username];
            },
            login: (username, password) => {
                const users = DataManager.getUsers();
                const user = users[username];
                return (user && user.password === password) ? user : null;
            },
            updateProfile: (username, profile) => {
                const users = DataManager.getUsers();
                if (users[username]) {
                    users[username].profile = profile;
                    localStorage.setItem('bs_users', JSON.stringify(users));
                    return users[username];
                }
                return null;
            },
            getSessions: (username) => JSON.parse(localStorage.getItem(`bs_sessions_${username}`) || '[]'),
            saveSessions: (username, sessions) => localStorage.setItem(`bs_sessions_${username}`, JSON.stringify(sessions)),
            getNotes: (username) => JSON.parse(localStorage.getItem(`bs_notes_${username}`) || '[]'),
            saveNote: (username, note) => {
                const notes = DataManager.getNotes(username);
                // Handle edits or new notes
                const existingIndex = notes.findIndex(n => n.id === note.id);
                let newNotes;
                if (existingIndex >= 0) {
                    newNotes = [...notes];
                    newNotes[existingIndex] = { ...newNotes[existingIndex], ...note };
                } else {
                    newNotes = [{...note, favorite: false}, ...notes];
                }
                localStorage.setItem(`bs_notes_${username}`, JSON.stringify(newNotes));
                return newNotes;
            },
            deleteNote: (username, noteId) => {
                const notes = DataManager.getNotes(username);
                const newNotes = notes.filter(n => n.id !== noteId);
                localStorage.setItem(`bs_notes_${username}`, JSON.stringify(newNotes));
                return newNotes;
            },
            toggleNoteFavorite: (username, noteId) => {
                const notes = DataManager.getNotes(username);
                const newNotes = notes.map(n => 
                    n.id === noteId ? { ...n, favorite: !n.favorite } : n
                );
                localStorage.setItem(`bs_notes_${username}`, JSON.stringify(newNotes));
                return newNotes;
            },
            saveBibleLoc: (username, bookId, chapter) => localStorage.setItem(`bs_bible_loc_${username}`, JSON.stringify({bookId, chapter})),
            getBibleLoc: (username) => JSON.parse(localStorage.getItem(`bs_bible_loc_${username}`) || '{"bookId":"GEN","chapter":1}'),
            
            // --- Settings & Progress ---
            getSettings: () => JSON.parse(localStorage.getItem('bs_settings') || '{"fontSize": 18}'),
            saveSettings: (settings) => localStorage.setItem('bs_settings', JSON.stringify(settings)),

            getDailyProgress: (username) => {
                const key = `bs_progress_${username}`;
                const today = new Date().toLocaleDateString('pt-BR');
                const stored = JSON.parse(localStorage.getItem(key) || '{}');
                if (stored.date !== today) {
                    const newStats = { date: today, current: 0, goal: stored.goal || 1 }; 
                    localStorage.setItem(key, JSON.stringify(newStats));
                    return newStats;
                }
                return stored;
            },
            updateDailyProgress: (username, increment = 1) => {
                const stats = DataManager.getDailyProgress(username);
                stats.current += increment;
                localStorage.setItem(`bs_progress_${username}`, JSON.stringify(stats));
                return stats;
            },
            setDailyGoal: (username, goal) => {
                const stats = DataManager.getDailyProgress(username);
                stats.goal = goal;
                localStorage.setItem(`bs_progress_${username}`, JSON.stringify(stats));
                return stats;
            },

            exportData: () => {
                const data = { ...localStorage };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `biblioscholar_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            },
            importData: (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        Object.keys(data).forEach(key => {
                            if (key.startsWith('bs_')) localStorage.setItem(key, data[key]);
                        });
                        alert("Backup restaurado!");
                        window.location.reload();
                    } catch (err) { alert("Erro ao ler backup."); }
                };
                reader.readAsText(file);
            }
        };

        const Icon = ({ name, size = 20, className = "", fill = "none" }) => {
            const ref = useRef(null);
            
            useEffect(() => {
                if(!window.lucide || !ref.current) return;
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                ref.current.innerHTML = '';
                ref.current.appendChild(i);
                window.lucide.createIcons({
                    root: ref.current,
                    attrs: { width: size, height: size, class: className, fill: fill === 'none' ? 'none' : fill }
                });
            }, [name, size, className, fill]);

            return <span ref={ref} style={{ display: 'inline-flex', width: size, height: size }} />;
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled=false, title='', ariaLabel='' }) => {
            const base = "px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500";
            const styles = {
                primary: "bg-amber-900 text-amber-50 shadow hover:bg-amber-800",
                secondary: "bg-white border border-stone-200 text-stone-700 hover:bg-stone-50",
                ghost: "text-stone-500 hover:bg-stone-100",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-200"
            };
            return <button onClick={onClick} disabled={disabled} title={title} aria-label={ariaLabel || title} className={`${base} ${styles[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>{children}</button>;
        };

        // --- OPTIMIZED COMPONENTS ---
        
        const VerseItem = React.memo(({ verse, isSelected, hasNote, markerColor, onClick, onLongPress, fontSize, selectionMode }) => {
            const markerStyle = markerColor ? { 
                borderBottom: `3px solid ${markerColor}`,
                backgroundColor: `${markerColor}20` // 20 hex opacity (approx 12%)
            } : {};

            const pressTimer = useRef(null);

            const handleTouchStart = () => {
                pressTimer.current = setTimeout(() => {
                    if (onLongPress) onLongPress(verse);
                }, 500); // 500ms long press
            };

            const handleTouchEnd = () => {
                if (pressTimer.current) clearTimeout(pressTimer.current);
            };

            return (
                <span 
                    onClick={() => onClick(verse)} 
                    onTouchStart={handleTouchStart}
                    onTouchEnd={handleTouchEnd}
                    onMouseDown={() => { if(!('ontouchstart' in window)) handleTouchStart() }}
                    onMouseUp={() => { if(!('ontouchstart' in window)) handleTouchEnd() }}
                    role="button"
                    tabIndex={0}
                    style={{ ...markerStyle, fontSize: `${fontSize}px` }}
                    className={`cursor-pointer hover:bg-amber-100 rounded px-1 transition-colors inline-block leading-relaxed mb-1 mr-1 ${isSelected ? 'bg-amber-800 text-white' : ''} ${hasNote && !markerColor && !isSelected ? 'has-note' : ''}`}
                >
                    <sup className={`text-xs font-sans mr-1 select-none font-bold align-super ${isSelected ? 'text-amber-200' : 'text-stone-400'}`}>
                        {verse.verse}
                        {hasNote && !isSelected && (
                            <span className="inline-flex items-center justify-center w-3 h-3 ml-0.5 bg-amber-100 text-amber-800 rounded-full text-[8px] align-middle shadow-sm">
                                <Icon name="file-text" size={8} />
                            </span>
                        )}
                    </sup>
                    {verse.text} 
                </span>
            );
        }, (prev, next) => {
            return prev.verse.verse === next.verse.verse && 
                   prev.isSelected === next.isSelected && 
                   prev.hasNote === next.hasNote &&
                   prev.markerColor === next.markerColor &&
                   prev.fontSize === next.fontSize &&
                   prev.selectionMode === next.selectionMode;
        });

        // --- SCREENS ---

        const AuthScreen = ({ onLogin }) => {
            const [isReg, setIsReg] = useState(false);
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [showPass, setShowPass] = useState(false);
            const [err, setErr] = useState('');

            const submit = (e) => {
                e.preventDefault();
                if (!user || !pass) return setErr("Preencha tudo.");
                const res = isReg ? DataManager.saveUser(user, pass) : DataManager.login(user, pass);
                if (res) onLogin(res); else setErr(isReg ? "Usu√°rio j√° existe" : "Usu√°rio ou senha inv√°lidos. Tente novamente.");
            };
            return (
                <div className="h-full flex items-center justify-center p-6 bg-[#fafaf9] overflow-y-auto custom-scroll">
                    <div className="max-w-sm w-full bg-white p-8 rounded-2xl shadow-xl border border-stone-100 fade-in my-auto">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-amber-900 text-white rounded-xl flex items-center justify-center mx-auto mb-2"><Icon name="feather"/></div>
                            <h1 className="text-xl font-serif font-bold text-stone-900">BiblioScholar</h1>
                        </div>
                        <form onSubmit={submit} className="space-y-4">
                            <div>
                                <label className="sr-only" htmlFor="username">Usu√°rio</label>
                                <input 
                                    id="username"
                                    value={user} 
                                    onChange={e=>setUser(e.target.value)} 
                                    className="w-full p-3 bg-white text-stone-900 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-800 outline-none placeholder-stone-400 transition-colors" 
                                    placeholder="Usu√°rio" 
                                />
                            </div>
                            <div className="relative">
                                <label className="sr-only" htmlFor="password">Senha</label>
                                <input 
                                    id="password"
                                    type={showPass ? "text" : "password"} 
                                    value={pass} 
                                    onChange={e=>setPass(e.target.value)} 
                                    className="w-full p-3 bg-white text-stone-900 border border-stone-200 rounded-lg focus:ring-2 focus:ring-amber-800 outline-none placeholder-stone-400 pr-10 transition-colors" 
                                    placeholder="Senha" 
                                />
                                <button 
                                    type="button"
                                    onClick={() => setShowPass(!showPass)}
                                    aria-label={showPass ? "Ocultar senha" : "Mostrar senha"}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-stone-400 hover:text-stone-600 p-1"
                                >
                                    <Icon name={showPass ? "eye-off" : "eye"} size={18} />
                                </button>
                            </div>
                            {err && <div className="p-3 bg-red-50 text-red-600 rounded-lg text-xs flex items-center gap-2"><Icon name="alert-circle" size={16}/> {err}</div>}
                            <Button className="w-full">
                                {isReg ? 'Criar Conta' : <><Icon name="log-in" size={18} /> Entrar</>}
                            </Button>
                        </form>
                        <button onClick={() => setIsReg(!isReg)} className="w-full mt-4 text-sm text-stone-500 underline">{isReg ? 'J√° tenho conta' : 'Criar conta nova'}</button>
                    </div>
                </div>
            );
        };

        const QuizScreen = ({ onComplete }) => {
            const [step, setStep] = useState(0);
            const [ans, setAns] = useState({});
            const qs = [
                { k: 'level', q: 'N√≠vel de conhecimento?', o: ['Iniciante', 'M√©dio', 'Te√≥logo'] },
                { k: 'interest', q: 'Interesse principal?', o: ['Hist√≥ria', 'Original', 'Devocional'] },
                { k: 'goal', q: 'Objetivo?', o: ['Pessoal', 'Pregar', 'Acad√™mico'] }
            ];
            return (
                <div className="h-full flex items-center justify-center p-6 bg-stone-50 overflow-y-auto custom-scroll">
                    <div className="max-w-md w-full fade-in">
                        <h2 className="text-xl font-serif font-bold mb-6 text-stone-900">{qs[step].q}</h2>
                        <div className="space-y-3">
                            {qs[step].o.map(opt => (
                                <button key={opt} onClick={() => {
                                    const n = { ...ans, [qs[step].k]: opt };
                                    setAns(n);
                                    if (step < 2) setStep(step + 1); else onComplete(n);
                                }} className="w-full p-4 bg-white border border-stone-200 rounded-xl text-left hover:border-amber-500 shadow-sm transition-colors text-stone-800">{opt}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VIEWS ---

        const HomeView = ({ user, onNavigate }) => {
            const today = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });
            const [progress, setProgress] = useState(DataManager.getDailyProgress(user.username));
            const [editingGoal, setEditingGoal] = useState(false);

            const refreshProgress = () => setProgress(DataManager.getDailyProgress(user.username));
            
            const SUGGESTED_STUDIES = useMemo(() => [
                { id: 1, title: "Serm√£o da Montanha", icon: "mountain", prompt: "Fa√ßa uma an√°lise profunda do Serm√£o da Montanha (Mateus 5-7), focando nas bem-aventuran√ßas e sua aplica√ß√£o pr√°tica hoje." },
                { id: 2, title: "Vida de Davi", icon: "crown", prompt: "Explore a ascens√£o e queda do Rei Davi, extraindo li√ß√µes de lideran√ßa, arrependimento e f√© a partir de 1 e 2 Samuel." },
                { id: 3, title: "Par√°bolas de Jesus", icon: "sprout", prompt: "Explique as principais par√°bolas de Jesus em Lucas, destacando o contexto cultural e o significado do Reino de Deus." },
                { id: 4, title: "Mulheres da B√≠blia", icon: "heart", prompt: "Destaque a import√¢ncia de Rute, Ester e Maria Madalena na narrativa b√≠blica e na hist√≥ria da reden√ß√£o." }
            ], []);

            const handleSetGoal = (newGoal) => {
                DataManager.setDailyGoal(user.username, parseInt(newGoal));
                refreshProgress();
                setEditingGoal(false);
            };

            const percentage = Math.min((progress.current / progress.goal) * 100, 100);

            return (
                <div className="h-full overflow-y-auto p-6 md:p-12 pb-32 custom-scroll">
                    <div className="max-w-4xl mx-auto fade-in">
                        <h1 className="text-xl md:text-3xl font-serif font-bold text-stone-900 mb-2">Ol√°, {user.username}.</h1>
                        <p className="text-stone-600 mb-6">Seu perfil: <strong>{user.profile.level}</strong>.</p>

                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-stone-200 mb-8 relative overflow-hidden">
                            <div className="flex justify-between items-end mb-2 relative z-10">
                                <div>
                                    <h3 className="text-stone-500 text-xs font-bold uppercase tracking-wider mb-1">Meta Di√°ria de Leitura</h3>
                                    {editingGoal ? (
                                        <div className="flex items-center gap-2">
                                            <input 
                                                type="number" 
                                                min="1" 
                                                max="50" 
                                                defaultValue={progress.goal} 
                                                id="goalInput" 
                                                className="w-16 p-1 border border-stone-300 rounded text-lg font-bold text-stone-900 bg-white text-center focus:ring-2 focus:ring-amber-500 outline-none" 
                                            />
                                            <button onClick={() => handleSetGoal(document.getElementById('goalInput').value)} className="bg-amber-900 text-white px-3 py-1 rounded text-sm hover:bg-amber-800 transition-colors">Salvar</button>
                                            <button onClick={() => setEditingGoal(false)} className="text-stone-400 text-sm hover:underline hover:text-stone-600">Cancelar</button>
                                        </div>
                                    ) : (
                                        <div className="flex items-baseline gap-2 cursor-pointer group" onClick={() => setEditingGoal(true)} title="Clique para alterar meta">
                                            <span className="text-3xl font-serif font-bold text-amber-900">{progress.current}</span>
                                            <span className="text-stone-400 font-serif">/ {progress.goal} cap√≠tulos</span>
                                            <Icon name="edit-2" size={14} className="text-stone-300 group-hover:text-amber-500 transition-colors ml-2"/>
                                        </div>
                                    )}
                                </div>
                                <div className="text-right">
                                    <Icon name={percentage >= 100 ? "trophy" : "target"} size={32} className={percentage >= 100 ? "text-amber-500" : "text-stone-200"} />
                                </div>
                            </div>
                            <div className="w-full bg-stone-100 rounded-full h-2 relative z-10">
                                <div className="bg-amber-900 h-2 rounded-full transition-all duration-1000" style={{ width: `${percentage}%` }}></div>
                            </div>
                            <div className="absolute -right-6 -bottom-6 w-32 h-32 bg-amber-50 rounded-full opacity-50 z-0"></div>
                        </div>

                        <div onClick={() => onNavigate('chat')} className="bg-amber-900 text-white p-8 rounded-2xl shadow-lg mb-8 cursor-pointer hover:shadow-xl transition-all relative overflow-hidden group transform hover:-translate-y-1">
                            <div className="relative z-10">
                                <h3 className="text-xl font-serif font-bold mb-2">Iniciar Novo Estudo</h3>
                                <p className="text-amber-100">Fa√ßa uma pergunta teol√≥gica para a IA.</p>
                            </div>
                        </div>

                        <h3 className="font-serif font-bold text-stone-900 mb-4 text-lg flex items-center gap-2">
                            <Icon name="sparkles" size={18} className="text-amber-600"/> Descubra Novos Estudos
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            {SUGGESTED_STUDIES.map(study => (
                                <div key={study.id} onClick={() => onNavigate('chat', study.prompt, study.title)} className="bg-white p-5 rounded-xl border border-stone-200 hover:border-amber-500 transition-all cursor-pointer shadow-sm hover:shadow-md group">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="p-2 bg-stone-50 text-stone-600 rounded-lg group-hover:bg-amber-50 group-hover:text-amber-900 transition-colors">
                                            <Icon name={study.icon} size={20} />
                                        </div>
                                        <h4 className="font-bold text-stone-800 text-base">{study.title}</h4>
                                    </div>
                                    <p className="text-xs text-stone-500 leading-relaxed line-clamp-2">{study.prompt}</p>
                                </div>
                            ))}
                        </div>

                        <h3 className="font-serif font-bold text-stone-900 mb-4 text-lg">Leitura Di√°ria ({today})</h3>
                        <div className="bg-stone-100 p-6 rounded-xl border border-stone-200 hover:border-amber-500 cursor-pointer transition-all flex items-center justify-between group" onClick={() => onNavigate('daily')}>
                            <div>
                                <h4 className="font-bold text-stone-800 mb-1">Devocional do Dia</h4>
                                <p className="text-sm text-stone-500">Descubra a leitura recomendada para hoje.</p>
                            </div>
                            <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-amber-900 shadow-sm group-hover:scale-110 transition-transform">
                                <Icon name="sun" size={20} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ sessions, onSelectSession, onDeleteSession }) => {
            const [search, setSearch] = useState('');
            const [viewMode, setViewMode] = useState('sessions'); // 'sessions' | 'notesByTopic'
            const [userNotes, setUserNotes] = useState([]);
            
            useEffect(() => {
                const u = JSON.parse(localStorage.getItem('bs_current_user'));
                if(u) setUserNotes(DataManager.getNotes(u.username));
            }, []);

            const groupedSessions = useMemo(() => {
                const now = new Date();
                const today = now.toLocaleDateString();
                const yesterday = new Date(now.setDate(now.getDate() - 1)).toLocaleDateString();
                
                const filtered = sessions.filter(s => 
                    (s.title || 'Novo Estudo').toLowerCase().includes(search.toLowerCase()) ||
                    (s.messages && s.messages.some(m => m.content.toLowerCase().includes(search.toLowerCase())))
                ).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

                const groups = { 'Hoje': [], 'Ontem': [], 'Antigos': [] };
                
                filtered.forEach(session => {
                    const d = new Date(session.updatedAt).toLocaleDateString();
                    if (d === today) groups['Hoje'].push(session);
                    else if (d === yesterday) groups['Ontem'].push(session);
                    else groups['Antigos'].push(session);
                });
                return groups;
            }, [sessions, search]);

            const groupedNotes = useMemo(() => {
                 const groups = {};
                 userNotes.forEach(n => {
                     const topic = n.topic || 'Geral';
                     if (!groups[topic]) groups[topic] = [];
                     groups[topic].push(n);
                 });
                 return groups;
            }, [userNotes]);

            return (
                <div className="h-full overflow-y-auto p-6 pb-32 custom-scroll">
                    <div className="max-w-2xl mx-auto fade-in">
                        <h2 className="text-xl font-serif font-bold text-stone-900 mb-4">Seus Estudos</h2>
                        
                        <div className="flex p-1 bg-stone-100 rounded-xl mb-6">
                             <button onClick={()=>setViewMode('sessions')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${viewMode==='sessions'?'bg-white text-stone-900 shadow-sm':'text-stone-500 hover:text-stone-700'}`}>Sess√µes de Chat</button>
                             <button onClick={()=>setViewMode('notesByTopic')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${viewMode==='notesByTopic'?'bg-white text-stone-900 shadow-sm':'text-stone-500 hover:text-stone-700'}`}>Por T√≥pico</button>
                        </div>
                        
                        {viewMode === 'sessions' && (
                            <>
                                <div className="relative mb-6">
                                    <input 
                                        type="text" 
                                        value={search}
                                        onChange={(e) => setSearch(e.target.value)}
                                        placeholder="Buscar nos estudos..." 
                                        className="w-full p-3 pl-10 bg-white border border-stone-200 rounded-xl focus:ring-2 focus:ring-amber-800 outline-none shadow-sm placeholder-stone-400"
                                    />
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-stone-400">
                                        <Icon name="search" size={18} />
                                    </div>
                                </div>

                                {sessions.length === 0 ? <p className="text-stone-500 italic text-center py-12">Nenhum estudo encontrado.</p> : 
                                    <div className="space-y-6">
                                        {Object.entries(groupedSessions).map(([label, group]) => group.length > 0 && (
                                            <div key={label}>
                                                <h3 className="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 ml-1">{label}</h3>
                                                <div className="space-y-3">
                                                    {group.map(session => (
                                                        <div key={session.id} className="flex gap-3 group">
                                                            <button onClick={() => onSelectSession(session)} className="flex-1 text-left bg-white p-5 rounded-xl border border-stone-200 hover:border-amber-500 shadow-sm transition-all active:scale-[0.99] focus:ring-2 focus:ring-amber-500 focus:outline-none min-w-0">
                                                                <h4 className="font-bold text-stone-800 mb-1 truncate">{session.title || 'Novo Estudo'}</h4>
                                                                <p className="text-xs text-stone-400 truncate">
                                                                    {session.messages && session.messages.length > 0 
                                                                        ? session.messages[session.messages.length-1].content.slice(0, 60) + '...' 
                                                                        : 'Sem mensagens'}
                                                                </p>
                                                            </button>
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation(); 
                                                                    if(confirm("Apagar este estudo?")) onDeleteSession(session.id);
                                                                }} 
                                                                aria-label="Apagar estudo"
                                                                className="bg-white px-4 rounded-xl border border-stone-200 text-stone-400 hover:text-red-600 hover:border-red-200 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 shrink-0"
                                                            >
                                                                <Icon name="trash-2" size={20} />
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                }
                            </>
                        )}

                        {viewMode === 'notesByTopic' && (
                            <div className="space-y-6">
                                {Object.keys(groupedNotes).length === 0 ? <p className="text-stone-500 italic text-center py-12">Nenhuma anota√ß√£o encontrada.</p> :
                                    Object.entries(groupedNotes).map(([topic, notes]) => (
                                        <div key={topic} className="bg-white rounded-xl border border-stone-200 overflow-hidden">
                                            <div className="bg-stone-50 p-4 border-b border-stone-100 font-bold text-stone-800 flex items-center gap-2">
                                                <Icon name="folder" size={16} className="text-amber-700"/> {topic}
                                            </div>
                                            <div className="divide-y divide-stone-100">
                                                {notes.map(n => (
                                                    <div key={n.id} className="p-4 hover:bg-stone-50 transition-colors">
                                                        <div className="flex justify-between items-start mb-1">
                                                            <span className="font-mono text-xs text-amber-900 bg-amber-100 px-2 py-0.5 rounded">{n.ref}</span>
                                                            <span className="text-[10px] text-stone-400">{new Date(n.date).toLocaleDateString()}</span>
                                                        </div>
                                                        <p className="text-sm font-medium text-stone-800 mb-1">{n.note}</p>
                                                        <p className="text-xs text-stone-500 italic">"{n.text}"</p>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const BibleView = ({ user, onNavigate, fontSize, currentTopic }) => {
            const saved = useMemo(() => DataManager.getBibleLoc(user.username), [user.username]);
            const [books, setBooks] = useState([]);
            const [bookId, setBookId] = useState(saved.bookId);
            const [bookName, setBookName] = useState('G√™nesis');
            const [chapter, setChapter] = useState(saved.chapter);
            const [text, setText] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selVerse, setSelVerse] = useState(null); // Single verse for modal
            const [note, setNote] = useState('');
            const [selColor, setSelColor] = useState(null);
            const [userNotes, setUserNotes] = useState(DataManager.getNotes(user.username));
            const [showBookSelector, setShowBookSelector] = useState(false);
            const [targetTopic, setTargetTopic] = useState(currentTopic);
            
            // MULTI SELECTION STATE
            const [selectionMode, setSelectionMode] = useState(false);
            const [selectedVerses, setSelectedVerses] = useState([]); // Array of entire verse objects

            // COLOR MEANINGS MAP
            const COLOR_MEANINGS = {
                '#fca5a5': 'üî¥ Pecado / Alerta / Perigo',
                '#fcd34d': 'üü° Divindade / Gl√≥ria / F√©',
                '#86efac': 'üü¢ Vida / Crescimento / Natureza',
                '#93c5fd': 'üîµ C√©u / Esp√≠rito Santo / Ora√ß√£o',
                '#d8b4fe': 'üü£ Realeza / Profecia / Promessa'
            };

            const TOPIC_SUGGESTIONS = useMemo(() => {
                const suggs = [];
                if(currentTopic && currentTopic !== 'Novo Estudo') suggs.push(currentTopic);
                suggs.push(`${bookName} Cap. ${chapter}`);
                suggs.push("Estudo Pessoal");
                suggs.push("Serm√£o / Prega√ß√£o");
                return suggs;
            }, [currentTopic, bookName, chapter]);

            useEffect(() => { setUserNotes(DataManager.getNotes(user.username)); }, [user.username]);

            useEffect(() => {
                const bks = [{id:'GEN',n:'G√™nesis'},{id:'EXO',n:'√äxodo'},{id:'LEV',n:'Lev√≠tico'},{id:'NUM',n:'N√∫meros'},{id:'DEU',n:'Deuteron√¥mio'},{id:'JOS',n:'Josu√©'},{id:'JDG',n:'Ju√≠zes'},{id:'RUT',n:'Rute'},{id:'1SA',n:'1 Samuel'},{id:'2SA',n:'2 Samuel'},{id:'PSA',n:'Salmos'},{id:'PRO',n:'Prov√©rbios'},{id:'ECC',n:'Eclesiastes'},{id:'SNG',n:'Cantares'},{id:'ISA',n:'Isa√≠as'},{id:'JER',n:'Jeremias'},{id:'LAM',n:'Lamenta√ß√µes'},{id:'EZK',n:'Ezequiel'},{id:'DAN',n:'Daniel'},{id:'HOS',n:'Oseias'},{id:'JOL',n:'Joel'},{id:'AMO',n:'Am√≥s'},{id:'OBA',n:'Obadias'},{id:'JON',n:'Jonas'},{id:'MIC',n:'Miqueias'},{id:'NAM',n:'Naum'},{id:'HAB',n:'Habacuque'},{id:'ZEP',n:'Sofonias'},{id:'HAG',n:'Ageu'},{id:'ZEC',n:'Zacarias'},{id:'MAL',n:'Malaquias'},{id:'MAT',n:'Mateus'},{id:'MRK',n:'Marcos'},{id:'LUK',n:'Lucas'},{id:'JHN',n:'Jo√£o'},{id:'ACT',n:'Atos'},{id:'ROM',n:'Romanos'},{id:'1CO',n:'1 Cor√≠ntios'},{id:'2CO',n:'2 Cor√≠ntios'},{id:'GAL',n:'G√°latas'},{id:'EPH',n:'Ef√©sios'},{id:'PHP',n:'Filipenses'},{id:'COL',n:'Colossenses'},{id:'1TH',n:'1 Tessalonicenses'},{id:'2TH',n:'2 Tessalonicenses'},{id:'1TI',n:'1 Tim√≥teo'},{id:'2TI',n:'2 Tim√≥teo'},{id:'TIT',n:'Tito'},{id:'PHM',n:'Filemom'},{id:'HEB',n:'Hebreus'},{id:'JAS',n:'Tiago'},{id:'1PE',n:'1 Pedro'},{id:'2PE',n:'2 Pedro'},{id:'1JN',n:'1 Jo√£o'},{id:'2JN',n:'2 Jo√£o'},{id:'3JN',n:'3 Jo√£o'},{id:'JUD',n:'Judas'},{id:'REV',n:'Apocalipse'}];
                setBooks(bks);
                const b = bks.find(x => x.id === bookId);
                if(b) setBookName(b.n);
                loadChapter(bookId, chapter);
            }, []); 

            const loadChapter = async (bid, ch) => {
                if (!ch || isNaN(ch) || ch < 1) { setChapter(ch); return; }
                setLoading(true);
                setText([]); 
                setSelectionMode(false);
                setSelectedVerses([]);
                try {
                    const res = await fetch(`https://bible-api.com/${bid}+${ch}?translation=almeida`);
                    const data = await res.json();
                    if(data.verses) {
                        ReactDOM.unstable_batchedUpdates(() => {
                            setText(data.verses);
                            setBookId(bid);
                            setChapter(ch);
                        });
                        DataManager.saveBibleLoc(user.username, bid, ch);
                    }
                } catch(e) { console.error("Erro API"); }
                setLoading(false);
            };

            const markChapterRead = () => {
                DataManager.updateDailyProgress(user.username, 1);
                alert(`Cap√≠tulo ${chapter} de ${bookName} marcado como lido!`);
            };

            // Enhanced Single Verse Save
            const saveNote = () => {
                const refCheck = `${bookName} ${chapter}:${selVerse.verse}`;
                const existingNote = userNotes.find(n => n.ref === refCheck);
                
                const notePayload = {
                    id: existingNote ? existingNote.id : Date.now(),
                    ref: refCheck,
                    text: selVerse.text,
                    note: note,
                    color: selColor,
                    topic: targetTopic, 
                    date: new Date().toISOString()
                };

                const newNotes = DataManager.saveNote(user.username, notePayload);
                setUserNotes(newNotes);
                
                setNote('');
                setSelColor(null);
                setSelVerse(null);
            };

            // Batch Actions
            const handleBatchCopy = () => {
                const sorted = [...selectedVerses].sort((a,b) => a.verse - b.verse);
                const textToCopy = sorted.map(v => `${v.verse}. ${v.text}`).join('\n');
                const ref = `${bookName} ${chapter}:${sorted[0].verse}-${sorted[sorted.length-1].verse}`;
                navigator.clipboard.writeText(`${ref}\n\n${textToCopy}`);
                setSelectionMode(false);
                setSelectedVerses([]);
                alert("Vers√≠culos copiados!");
            };

            const handleBatchColor = (color) => {
                 let updatedNotes = [...userNotes];
                 selectedVerses.forEach(v => {
                     const refCheck = `${bookName} ${chapter}:${v.verse}`;
                     const existingIndex = updatedNotes.findIndex(n => n.ref === refCheck);
                     const notePayload = {
                        id: existingIndex >= 0 ? updatedNotes[existingIndex].id : Date.now() + Math.random(),
                        ref: refCheck,
                        text: v.text,
                        note: existingIndex >= 0 ? updatedNotes[existingIndex].note : '',
                        color: color,
                        topic: currentTopic,
                        date: new Date().toISOString()
                     };
                     updatedNotes = DataManager.saveNote(user.username, notePayload);
                 });
                 setUserNotes(updatedNotes);
                 setSelectionMode(false);
                 setSelectedVerses([]);
            };

            const handleColorUpdate = (color) => {
                setSelColor(color);
                const refCheck = `${bookName} ${chapter}:${selVerse.verse}`;
                const existingNote = userNotes.find(n => n.ref === refCheck);
                
                const notePayload = {
                    id: existingNote ? existingNote.id : Date.now(),
                    ref: refCheck,
                    text: selVerse.text,
                    note: note,
                    color: color,
                    topic: targetTopic,
                    date: new Date().toISOString()
                };

                const newNotes = DataManager.saveNote(user.username, notePayload);
                setUserNotes(newNotes);
            };

            const handleShare = async () => {
                const shareText = `"${selVerse.text}" - ${bookName} ${chapter}:${selVerse.verse}`;
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'BiblioScholar',
                            text: shareText + (note ? `\n\nNota: ${note}` : '')
                        });
                    } catch (err) { console.log('Erro ao compartilhar', err); }
                } else {
                    navigator.clipboard.writeText(shareText);
                    alert("Vers√≠culo copiado para a √°rea de transfer√™ncia!");
                }
            };

            const getVerseData = useCallback((verseNum) => {
                const refCheck = `${bookName} ${chapter}:${verseNum}`;
                const note = userNotes.find(n => n.ref === refCheck);
                return { hasNote: !!note, color: note?.color };
            }, [bookName, chapter, userNotes]);

            const handleVerseClick = useCallback((v) => {
                if (selectionMode) {
                    setSelectedVerses(prev => {
                        const exists = prev.find(pv => pv.verse === v.verse);
                        if (exists) return prev.filter(pv => pv.verse !== v.verse);
                        return [...prev, v];
                    });
                } else {
                    setSelVerse(v);
                    const data = getVerseData(v.verse);
                    setTargetTopic(currentTopic || `${bookName} Cap. ${chapter}`);
                    if(data.hasNote) {
                         const refCheck = `${bookName} ${chapter}:${v.verse}`;
                         const n = userNotes.find(not => not.ref === refCheck);
                         setNote(n.note || '');
                         setSelColor(n.color || null);
                         if(n.topic) setTargetTopic(n.topic);
                    } else {
                        setNote('');
                        setSelColor(null);
                    }
                }
            }, [selectionMode, getVerseData, userNotes, bookName, chapter, currentTopic]);

            const handleLongPress = useCallback((v) => {
                if (!selectionMode) {
                    setSelectionMode(true);
                    setSelectedVerses([v]);
                }
            }, [selectionMode]);

            return (
                <div className="flex flex-col h-full bg-white relative">
                    <div className="p-4 bg-white border-b flex gap-2 sticky top-0 z-10 shadow-sm items-center">
                        {selectionMode ? (
                            <div className="flex-1 flex items-center justify-between animate-fade-in bg-amber-50 p-2 rounded-lg border border-amber-200">
                                <span className="font-bold text-amber-900 ml-2">{selectedVerses.length} selecionados</span>
                                <button onClick={()=>{setSelectionMode(false); setSelectedVerses([])}} className="text-amber-800 p-2"><Icon name="x"/></button>
                            </div>
                        ) : (
                            <>
                                <button 
                                    onClick={() => setShowBookSelector(true)}
                                    className="p-3 bg-stone-50 border border-stone-200 rounded-lg flex-1 font-serif text-stone-800 text-base text-left flex justify-between items-center active:bg-stone-100"
                                >
                                    <span className="truncate">{bookName}</span>
                                    <Icon name="chevron-down" size={16} className="text-stone-400" />
                                </button>
                                <label htmlFor="chapter-input" className="sr-only">Cap√≠tulo</label>
                                <input id="chapter-input" type="number" className="w-20 p-3 bg-stone-50 border border-stone-200 rounded-lg text-center text-base" value={chapter} onChange={e=>loadChapter(bookId, e.target.value)}/>
                                <button aria-label="Pr√≥ximo cap√≠tulo" onClick={()=>loadChapter(bookId, parseInt(chapter)+1)} className="p-3 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors"><Icon name="arrow-right"/></button>
                                <button aria-label="Modo Sele√ß√£o" onClick={()=>setSelectionMode(!selectionMode)} className={`p-3 rounded-lg transition-colors ml-1 ${selectionMode ? 'bg-amber-800 text-white' : 'bg-stone-100 text-stone-600'}`}><Icon name="check-square" size={20}/></button>
                            </>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 md:p-8 bg-[#fafaf9] font-serif leading-relaxed pb-32 custom-scroll text-stone-800 select-none">
                        {loading ? (
                            <div className="text-center text-stone-400 mt-20 italic">Carregando escrituras...</div>
                        ) : (
                            <>
                                {text.map(v => {
                                    const vData = getVerseData(v.verse);
                                    const isSelected = selectedVerses.some(sv => sv.verse === v.verse);
                                    return (
                                        <VerseItem 
                                            key={v.verse} 
                                            verse={v} 
                                            isSelected={selVerse?.verse === v.verse || isSelected} 
                                            hasNote={vData.hasNote}
                                            markerColor={vData.color} 
                                            onClick={handleVerseClick}
                                            onLongPress={handleLongPress}
                                            fontSize={fontSize}
                                            selectionMode={selectionMode}
                                        />
                                    );
                                })}
                                {text.length > 0 && !selectionMode && (
                                    <div className="mt-8 pt-8 border-t border-stone-200 text-center">
                                        <Button onClick={markChapterRead} variant="secondary" className="w-full md:w-auto mx-auto border-amber-200 bg-amber-50 text-amber-900 hover:bg-amber-100">
                                            <Icon name="check-circle" size={18}/> Concluir Leitura do Cap√≠tulo
                                        </Button>
                                    </div>
                                )}
                            </>
                        )}
                    </div>

                    {/* BATCH ACTION BAR */}
                    {selectionMode && selectedVerses.length > 0 && (
                        <div className="fixed bottom-20 md:bottom-4 left-4 right-4 bg-white p-4 rounded-2xl shadow-2xl border border-stone-200 flex justify-around items-center z-50 animate-slide-up">
                            <button onClick={handleBatchCopy} className="flex flex-col items-center text-stone-600 hover:text-amber-900"><div className="p-2 bg-stone-100 rounded-full mb-1"><Icon name="copy" size={20}/></div><span className="text-[10px] font-bold">Copiar</span></button>
                            <div className="h-8 w-px bg-stone-200"></div>
                            {/* Color Picker Mini */}
                            <div className="flex gap-2">
                                <button onClick={()=>handleBatchColor(null)} className="w-8 h-8 rounded-full border border-stone-300 bg-stone-50 flex items-center justify-center"><Icon name="slash" size={14}/></button>
                                {['#fca5a5', '#fcd34d', '#86efac'].map(c => (
                                    <button key={c} onClick={()=>handleBatchColor(c)} className="w-8 h-8 rounded-full border border-transparent hover:scale-110 transition-transform" style={{backgroundColor: c}}/>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* BOOK SELECTOR MODAL (Keep as is) */}
                    {showBookSelector && (
                        <div className="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-50 flex flex-col slide-up">
                            <div className="bg-white rounded-t-2xl flex-1 mt-10 overflow-hidden flex flex-col shadow-2xl">
                                <div className="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                                    <h3 className="font-serif font-bold text-lg text-stone-900">Selecionar Livro</h3>
                                    <button onClick={() => setShowBookSelector(false)} className="p-2 bg-stone-200 rounded-full text-stone-600"><Icon name="x" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 custom-scroll">
                                    <h4 className="font-bold text-stone-400 text-xs uppercase tracking-wider mb-3 sticky top-0 bg-white py-2">Antigo Testamento</h4>
                                    <div className="grid grid-cols-3 gap-2 mb-6">
                                        {books.slice(0, 39).map(b => (
                                            <button 
                                                key={b.id} 
                                                onClick={() => {
                                                    setBookId(b.id);
                                                    setBookName(b.n);
                                                    loadChapter(b.id, 1);
                                                    setShowBookSelector(false);
                                                }}
                                                className={`p-3 text-sm rounded-lg border ${bookId === b.id ? 'bg-amber-100 border-amber-300 text-amber-900 font-bold' : 'bg-stone-50 border-stone-100 text-stone-700 hover:bg-stone-100'}`}
                                            >
                                                {b.n}
                                            </button>
                                        ))}
                                    </div>
                                    <h4 className="font-bold text-stone-400 text-xs uppercase tracking-wider mb-3 sticky top-0 bg-white py-2">Novo Testamento</h4>
                                    <div className="grid grid-cols-3 gap-2 pb-10">
                                        {books.slice(39).map(b => (
                                            <button 
                                                key={b.id} 
                                                onClick={() => {
                                                    setBookId(b.id);
                                                    setBookName(b.n);
                                                    loadChapter(b.id, 1);
                                                    setShowBookSelector(false);
                                                }}
                                                className={`p-3 text-sm rounded-lg border ${bookId === b.id ? 'bg-amber-100 border-amber-300 text-amber-900 font-bold' : 'bg-stone-50 border-stone-100 text-stone-700 hover:bg-stone-100'}`}
                                            >
                                                {b.n}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {selVerse && (
                        <div className="fixed inset-0 bg-stone-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl animate-slide-up border-t-4 border-amber-800 max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between mb-2">
                                    <h3 className="font-bold text-stone-900 text-lg font-serif">{bookName} {chapter}:{selVerse.verse}</h3>
                                    <button aria-label="Fechar" onClick={()=>setSelVerse(null)}><Icon name="x"/></button>
                                </div>
                                
                                {/* TOPIC SUGGESTIONS */}
                                <div className="mb-4">
                                    <p className="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">Sugerir T√≥pico</p>
                                    <div className="flex flex-wrap gap-2">
                                        {TOPIC_SUGGESTIONS.map(s => (
                                            <button 
                                                key={s} 
                                                onClick={() => {
                                                    setTargetTopic(s);
                                                    alert(`T√≥pico "${s}" selecionado para esta nota.`);
                                                }}
                                                className={`px-3 py-1 text-xs font-medium rounded-full border transition-colors ${targetTopic === s ? 'bg-amber-900 text-white border-amber-900' : 'bg-stone-100 text-stone-600 hover:bg-amber-100 border-stone-200'}`}
                                            >
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <p className="italic text-stone-600 text-sm mb-4 border-l-4 border-amber-500 pl-3 py-1 bg-stone-50 rounded-r">"{selVerse.text}"</p>
                                
                                {/* Color Selector for Highlighting */}
                                <div className="mb-4">
                                    <label className="text-xs font-bold text-stone-500 uppercase mb-2 block">Marcador</label>
                                    <div className="flex gap-3 mb-2">
                                        <button onClick={()=>handleColorUpdate(null)} className={`w-8 h-8 rounded-full border-2 flex items-center justify-center ${selColor === null ? 'border-stone-400 bg-stone-100' : 'border-transparent bg-stone-50'}`} title="Sem cor"><Icon name="slash" size={14} className="text-stone-400"/></button>
                                        {Object.keys(COLOR_MEANINGS).map(c => (
                                            <button 
                                                key={c} 
                                                onClick={()=>handleColorUpdate(c)} 
                                                className={`w-8 h-8 rounded-full border-2 transition-transform active:scale-95 ${selColor === c ? 'border-stone-600 scale-110' : 'border-transparent'}`} 
                                                style={{backgroundColor: c}}
                                            />
                                        ))}
                                    </div>
                                    {selColor && (
                                        <p className="text-xs font-medium text-stone-600 bg-stone-100 p-2 rounded-lg fade-in">
                                            {COLOR_MEANINGS[selColor]}
                                        </p>
                                    )}
                                </div>

                                <textarea className="w-full p-4 border border-stone-200 bg-white text-stone-900 rounded-lg mb-4 text-base focus:ring-2 focus:ring-amber-500 outline-none placeholder-stone-400" rows="3" placeholder="Sua anota√ß√£o pessoal..." value={note} onChange={e=>setNote(e.target.value)}/>
                                <div className="grid grid-cols-2 gap-2 mb-2">
                                    <Button onClick={saveNote} className="py-3"><Icon name="save" size={18}/> Salvar</Button>
                                    <Button onClick={()=>{
                                        onNavigate('chat', `Fa√ßa exegese de ${bookName} ${chapter}:${selVerse.verse}: "${selVerse.text}"`);
                                    }} variant="secondary" className="py-3"><Icon name="sparkles" size={18}/> Explicar</Button>
                                </div>
                                <Button onClick={handleShare} variant="ghost" className="w-full text-stone-500 border border-stone-200 mt-2"><Icon name="share-2" size={18}/> Compartilhar</Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const NotesView = ({ user }) => {
            const [notes, setNotes] = useState(DataManager.getNotes(user.username));
            const [filter, setFilter] = useState('all'); 
            
            useEffect(() => {
                setNotes(DataManager.getNotes(user.username));
            }, [user.username]);

            const handleDelete = (id) => {
                if(confirm("Deseja apagar esta nota?")) {
                    const updated = DataManager.deleteNote(user.username, id);
                    setNotes(updated);
                }
            };

            const handleToggleFavorite = (id) => {
                const updated = DataManager.toggleNoteFavorite(user.username, id);
                setNotes(updated);
            };

            const displayedNotes = useMemo(() => {
                return filter === 'fav' ? notes.filter(n => n.favorite) : notes;
            }, [notes, filter]);

            return (
                <div className="h-full overflow-y-auto p-6 pb-32 custom-scroll">
                    <div className="max-w-2xl mx-auto fade-in">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-xl font-serif font-bold text-stone-900">Caderno de Anota√ß√µes</h2>
                        </div>
                        
                        <div className="flex p-1 bg-stone-100 rounded-xl mb-6 w-full max-w-xs">
                            <button onClick={()=>setFilter('all')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${filter==='all'?'bg-white text-stone-900 shadow-sm':'text-stone-500 hover:text-stone-700'}`}>Todas</button>
                            <button onClick={()=>setFilter('fav')} className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-1 ${filter==='fav'?'bg-white text-amber-900 shadow-sm':'text-stone-500 hover:text-stone-700'}`}><Icon name="star" size={14} className={filter==='fav'?'fill-amber-900':''}/> Favoritas</button>
                        </div>

                        {displayedNotes.length === 0 ? (
                            <div className="text-center py-16">
                                <div className="w-16 h-16 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-4 text-stone-300">
                                    <Icon name={filter === 'fav' ? 'star' : 'notebook-pen'} size={32}/>
                                </div>
                                <p className="text-stone-400 italic">
                                    {filter === 'fav' ? 'Nenhuma nota favorita encontrada.' : 'Nenhuma anota√ß√£o. Leia a B√≠blia para criar.'}
                                </p>
                            </div>
                        ) : 
                            <div className="space-y-4 fade-in" key={filter}>
                                {displayedNotes.map(n => (
                                    <div key={n.id} className="bg-white p-0 rounded-xl shadow-sm border border-stone-100 overflow-hidden hover:border-amber-300 transition-all group">
                                        <div className="p-5">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2">
                                                    <span className="bg-amber-100 text-amber-900 text-xs font-bold px-2 py-1 rounded-md font-mono flex items-center gap-1">
                                                        <Icon name="bookmark" size={12} className="fill-amber-900"/> {n.ref}
                                                    </span>
                                                    {n.color && <div className="w-3 h-3 rounded-full" style={{backgroundColor: n.color}} title="Marcador"></div>}
                                                </div>
                                                <div className="flex gap-1">
                                                     <button 
                                                        onClick={() => handleToggleFavorite(n.id)} 
                                                        aria-label={n.favorite ? "Desfavoritar" : "Favoritar"}
                                                        className={`p-2 rounded-full transition-colors hover:bg-stone-50 ${n.favorite ? 'text-amber-500' : 'text-stone-300 hover:text-amber-400'}`}
                                                        title="Favoritar"
                                                    >
                                                        <Icon name="star" size={18} className={n.favorite ? "fill-amber-500" : ""} />
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDelete(n.id)} 
                                                        aria-label="Excluir nota"
                                                        className="text-stone-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors"
                                                        title="Excluir"
                                                    >
                                                        <Icon name="trash-2" size={18}/>
                                                    </button>
                                                </div>
                                            </div>
                                            {n.note && <p className="text-stone-800 mb-4 leading-relaxed font-medium">{n.note}</p>}
                                            
                                            <div className="bg-stone-50 p-3 rounded-lg border-l-2 border-stone-300" style={n.color ? {borderLeftColor: n.color} : {}}>
                                                <p className="text-sm text-stone-500 italic font-serif leading-snug">"{n.text}"</p>
                                            </div>
                                        </div>
                                        <div className="bg-stone-50 px-5 py-2 border-t border-stone-100 flex items-center justify-between text-xs text-stone-400 font-medium">
                                            <span className="truncate max-w-[150px]">{n.topic ? `Estudo: ${n.topic}` : ''}</span>
                                            <span className="flex items-center"><Icon name="calendar" size={12} className="mr-1"/> {new Date(n.date).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        }
                    </div>
                </div>
            );
        };

        const SettingsView = ({ user, fontSize, onFontSizeChange }) => (
            <div className="h-full overflow-y-auto p-6 pb-32 custom-scroll">
                <div className="max-w-2xl mx-auto fade-in">
                    <h2 className="text-xl font-serif font-bold text-stone-900 mb-6">Ajustes</h2>
                    
                    {/* Font Size Slider */}
                    <div className="bg-white p-6 rounded-xl border border-stone-200 mb-6 shadow-sm">
                        <h3 className="font-bold mb-4 text-stone-800 flex items-center gap-2"><Icon name="type" size={18} /> Tamanho do Texto</h3>
                        <div className="flex items-center gap-4">
                            <span className="text-xs font-serif text-stone-400">A</span>
                            <input 
                                type="range" 
                                min="10" 
                                max="28" 
                                step="1" 
                                value={fontSize} 
                                onChange={(e) => onFontSizeChange(parseInt(e.target.value))}
                                aria-label="Ajustar tamanho da fonte"
                            />
                            <span className="text-xl font-serif text-stone-900 font-bold">A</span>
                        </div>
                        <p className="text-center text-sm text-stone-500 mt-2">{fontSize}px</p>
                        <div className="mt-4 p-3 bg-stone-50 rounded border border-stone-100">
                            <p className="font-serif leading-relaxed text-stone-800" style={{ fontSize: `${fontSize}px` }}>
                                "L√¢mpada para os meus p√©s √© tua palavra, e luz para o meu caminho."
                            </p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl border border-stone-200 mb-6 shadow-sm">
                        <h3 className="font-bold mb-2 text-stone-800">Backup de Dados</h3>
                        <p className="text-sm text-stone-500 mb-4">Salve seus estudos e notas para usar em outro dispositivo.</p>
                        <div className="flex flex-col gap-3">
                            <Button onClick={DataManager.exportData} variant="secondary"><Icon name="download"/> Baixar Backup (JSON)</Button>
                            <div className="relative group">
                                <label htmlFor="file-upload" className="sr-only">Upload de backup</label>
                                <input id="file-upload" type="file" className="absolute inset-0 opacity-0 cursor-pointer z-10" onChange={e=>DataManager.importData(e.target.files[0])} />
                                <Button variant="outline" className="w-full group-hover:bg-stone-50"><Icon name="upload"/> Restaurar Backup</Button>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                        <h3 className="font-bold mb-4 text-stone-800">Groq API Key</h3>
                        
                        {/* Security UI: Do not show input */}
                        <div className="bg-stone-50 p-4 rounded-lg border border-stone-200 flex items-center gap-3 mb-3">
                            <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-700">
                                <Icon name="shield-check" />
                            </div>
                            <div>
                                <p className="font-bold text-stone-800 text-sm">Chave Ativa e Segura</p>
                                <p className="text-xs text-stone-500">Sua chave est√° salva localmente no dispositivo.</p>
                            </div>
                        </div>

                        <button onClick={()=>{localStorage.removeItem('gemini_api_key'); window.location.reload();}} className="w-full border border-red-200 bg-red-50 text-red-600 rounded-lg py-3 text-sm font-medium hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                            <Icon name="trash-2" size={16}/> Remover Chave e Sair
                        </button>
                    </div>
                </div>
            </div>
        );

        const ChatView = ({ user, apiKey, promptInit, session, onUpdateSession }) => {
            const [msgs, setMsgs] = useState(session?.messages || []);
            const [input, setInput] = useState('');
            const [streaming, setStreaming] = useState(false);
            const abortControllerRef = useRef(null);
            const botRef = useRef(null);
            const inputRef = useRef(null);

            useEffect(() => {
                const draft = localStorage.getItem(`bs_chat_draft_${user.username}`);
                if (draft) setInput(draft);
            }, []);

            useEffect(() => {
                if (session?.messages && !streaming) setMsgs(session.messages);
            }, [session, streaming]);

            useEffect(() => {
                if (promptInit && !streaming) {
                     setInput(promptInit);
                     localStorage.setItem(`bs_chat_draft_${user.username}`, promptInit);
                }
            }, [promptInit]);

            useEffect(() => botRef.current?.scrollIntoView({behavior:'smooth'}), [msgs, streaming]);

            const stopGeneration = () => {
                if(abortControllerRef.current) {
                    abortControllerRef.current.abort();
                    setStreaming(false);
                    abortControllerRef.current = null;
                }
            };
            
            const handleInputChange = (e) => {
                const val = e.target.value;
                setInput(val);
                localStorage.setItem(`bs_chat_draft_${user.username}`, val);
            };

            const send = async (txt = input) => {
                if (!txt.trim() || streaming) return;
                
                const userMsg = {role:'user', content:txt};
                const newMsgs = [...msgs, userMsg];
                setMsgs(newMsgs);
                setInput('');
                localStorage.removeItem(`bs_chat_draft_${user.username}`);
                
                let updatedSession = { ...session };
                if (session && (session.title === 'Novo Estudo' || !session.title)) {
                    const newTitle = txt.length > 30 ? txt.substring(0, 30) + '...' : txt;
                    updatedSession.title = newTitle;
                }
                
                updatedSession.messages = newMsgs;
                updatedSession.updatedAt = new Date().toISOString();

                if(onUpdateSession) {
                    onUpdateSession(updatedSession);
                }

                setStreaming(true);
                const abortController = new AbortController();
                abortControllerRef.current = abortController;

                try {
                    const sys = SYSTEM_PROMPT_TEMPLATE
                        .replace('{{USERNAME}}', user.username)
                        .replace('{{LEVEL}}', user.profile.level)
                        .replace('{{INTEREST}}', user.profile.interest)
                        .replace('{{GOAL}}', user.profile.goal);

                    const messagesPayload = [
                        { role: "system", content: sys },
                        ...newMsgs.map(m => ({ role: m.role === 'model' ? 'assistant' : 'user', content: m.content }))
                    ];

                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${apiKey}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: messagesPayload,
                            stream: true,
                            max_tokens: 8000
                        }),
                        signal: abortController.signal
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "Erro na API Groq");
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let fullText = "";
                    setMsgs(p => [...p, {role:'model', content:''}]);

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split("\n");
                        
                        for (const line of lines) {
                            if (line.startsWith("data: ") && line !== "data: [DONE]") {
                                try {
                                    const json = JSON.parse(line.substring(6));
                                    const content = json.choices[0]?.delta?.content || "";
                                    fullText += content;
                                    setMsgs(prev => {
                                        const u = [...prev];
                                        u[u.length-1].content = fullText;
                                        return u;
                                    });
                                } catch (e) { }
                            }
                        }
                    }

                    if(onUpdateSession && !abortController.signal.aborted) {
                        onUpdateSession({
                            ...updatedSession, 
                            messages: [...newMsgs, {role:'model', content: fullText}],
                            updatedAt: new Date().toISOString()
                        });
                    }

                } catch(e) {
                    if (!abortController.signal.aborted) {
                        setMsgs(p => [...p, {role:'model', content: `‚ö†Ô∏è **Erro:** ${e.message}\nVerifique sua chave Groq.`}]);
                    }
                } finally { 
                    setStreaming(false); 
                    abortControllerRef.current = null;
                }
            };

            return (
                <div className="flex flex-col h-full bg-stone-50">
                    <div className="flex-1 overflow-y-auto p-4 pb-32 custom-scroll">
                        {msgs.length===0 && <div className="text-center mt-32 text-stone-400 animate-fade-in"><Icon name="sparkles" size={48} className="mx-auto mb-2 opacity-50"/><p>Inicie sua jornada de estudo...</p></div>}
                        <div className="max-w-3xl mx-auto space-y-6">
                            {msgs.map((m,i)=>(
                                <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'} fade-in`}>
                                    <div className={`max-w-[90%] md:max-w-[80%] p-5 rounded-2xl shadow-sm leading-relaxed ${m.role==='user'?'bg-white text-stone-800 border-stone-100 rounded-tr-none':'bg-white border-stone-100 rounded-tl-none'}`}>
                                        {m.role==='user'?<p className="whitespace-pre-wrap">{m.content}</p>:<div className="markdown-body" dangerouslySetInnerHTML={{__html: marked.parse(m.content)}}/>}
                                    </div>
                                </div>
                            ))}
                            {streaming && (
                                <div className="flex justify-start fade-in">
                                    <div className="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-stone-100 flex gap-1 items-center">
                                        <div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div>
                                    </div>
                                </div>
                            )}
                            <div ref={botRef}/>
                        </div>
                    </div>
                    <div className="p-4 bg-white/80 backdrop-blur-md border-t border-stone-200 md:mb-16 mb-20 shadow-[0_-5px_20px_rgba(0,0,0,0.02)] pb-safe">
                        <div className="max-w-3xl mx-auto flex gap-2 items-end">
                            <label htmlFor="chat-input" className="sr-only">Digite sua pergunta</label>
                            <input 
                                id="chat-input"
                                ref={inputRef}
                                value={input} 
                                onChange={handleInputChange} 
                                onKeyDown={e=>e.key==='Enter'&&send()} 
                                className="flex-1 p-4 bg-stone-50 border border-stone-200 rounded-xl focus:ring-2 focus:ring-amber-900/10 focus:border-amber-800 outline-none transition-all shadow-inner text-stone-800 placeholder-stone-400 min-w-0" 
                                placeholder="Digite sua pergunta teol√≥gica..."
                            />
                            {streaming ? (
                                <Button onClick={stopGeneration} variant="danger" title="Parar" className="h-[58px] w-[58px] rounded-xl flex items-center justify-center p-0 shadow-lg flex-shrink-0"><Icon name="square" size={20} fill="currentColor" /></Button>
                            ) : (
                                <Button onClick={()=>send()} disabled={!input.trim()} title="Enviar" className="h-[58px] w-[58px] rounded-xl flex items-center justify-center p-0 shadow-lg bg-amber-900 hover:bg-amber-800 flex-shrink-0"><Icon name="send" size={20}/></Button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('bs_current_user')));
            const [tab, setTab] = useState('home');
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key'));
            const [tempKey, setTempKey] = useState('');
            const [chatData, setChatData] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [currentSession, setCurrentSession] = useState(null);
            const [currentTopic, setCurrentTopic] = useState(null);
            
            // Global Settings State
            const [fontSize, setFontSize] = useState(DataManager.getSettings().fontSize);

            const handleFontSizeChange = (size) => {
                setFontSize(size);
                DataManager.saveSettings({ fontSize: size });
            };
            
            const mainRef = useRef(null);
            useEffect(() => {
                if (mainRef.current) mainRef.current.scrollTop = 0;
            }, [tab]);

            useEffect(() => { if(user) localStorage.setItem('bs_current_user', JSON.stringify(user)); }, [user]);
            useEffect(() => { if(user) setSessions(DataManager.getSessions(user.username)); }, [user]);

            const createNewSession = () => {
                setChatData(null);
                setCurrentTopic(null);
                const newSess = { 
                    id: Date.now().toString(), 
                    title: 'Novo Estudo', 
                    messages: [{role:'model', content:`Ol√° ${user.username}. Vamos estudar?`}], 
                    updatedAt: new Date().toISOString() 
                };
                setSessions(prev => [newSess, ...prev]);
                setCurrentSession(newSess);
                DataManager.saveSessions(user.username, [newSess, ...sessions]);
                setTab('chat');
            };

            const loadSession = useCallback((s) => {
                setChatData(null);
                setCurrentSession(s); 
                setCurrentTopic(s.title);
                setTab('chat');
            }, []);

            const updateSessionInRealTime = useCallback((updatedSession) => {
               setSessions(prev => {
                   const newSessions = prev.map(s => s.id === updatedSession.id ? updatedSession : s);
                   DataManager.saveSessions(user.username, newSessions);
                   return newSessions;
               });
               setCurrentSession(updatedSession);
            }, [user]);

            const deleteSession = useCallback((id) => {
                setSessions(prev => {
                    const left = prev.filter(s=>s.id!==id);
                    DataManager.saveSessions(user.username, left);
                    return left;
                });
                if(currentSession?.id===id) setCurrentSession(null);
            }, [user, currentSession]);

            const startDaily = () => {
                const topic = 'Devocional Di√°rio';
                setCurrentTopic(topic);
                const newSess = { id: Date.now().toString(), title: topic, messages: [], updatedAt: new Date().toISOString() };
                setSessions(prev => [newSess, ...prev]);
                setCurrentSession(newSess);
                DataManager.saveSessions(user.username, [newSess, ...sessions]);
                setChatData("Qual a leitura b√≠blica e devocional para hoje?");
                setTab('chat');
            };

            const startPromptChat = (prompt, topicTitle) => {
                const title = topicTitle || 'Estudo R√°pido';
                setCurrentTopic(title); 
                const newSess = { id: Date.now().toString(), title: title, messages: [], updatedAt: new Date().toISOString() };
                setSessions(prev => [newSess, ...prev]);
                setCurrentSession(newSess);
                DataManager.saveSessions(user.username, [newSess, ...sessions]);
                setChatData(prompt);
                setTab('chat');
            };

            const handleSaveKey = () => {
                localStorage.setItem('gemini_api_key', tempKey);
                setApiKey(tempKey);
            };
            
            const handleLogin = (u) => {
                setUser(u);
            };
            
            const handleLogout = () => {
                localStorage.removeItem('bs_current_user'); 
                setUser(null);
            };

            if (!user) return <AuthScreen onLogin={handleLogin} />;
            if (!user.profile) return <QuizScreen onComplete={p => {
                const updatedUser = DataManager.updateProfile(user.username, p);
                setUser(updatedUser);
            }} />;
            
            if (!apiKey) return (
                <div className="fixed inset-0 bg-stone-900/90 flex items-center justify-center p-6 backdrop-blur-sm">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-2xl border-t-4 border-amber-800 animate-fade-in">
                        <div className="w-12 h-12 bg-stone-100 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-800"><Icon name="key" /></div>
                        <h2 className="font-serif font-bold text-xl mb-2 text-stone-900">Chave de Acesso (Groq)</h2>
                        <p className="text-sm text-stone-500 mb-6 leading-relaxed">Para conectar a IA (Llama 3), cole sua chave da Groq abaixo.</p>
                        <input className="w-full p-4 border border-stone-200 bg-white text-stone-900 rounded-xl mb-4 focus:ring-2 focus:ring-amber-800 outline-none transition-all font-mono text-sm placeholder-stone-400" type="password" placeholder="Cole aqui (gsk_...)" onChange={e => setTempKey(e.target.value)} />
                        <Button className="w-full py-4 text-lg shadow-xl" onClick={handleSaveKey}>Conectar</Button>
                        <a href="https://console.groq.com/keys" target="_blank" className="text-xs text-amber-800 mt-6 block hover:underline font-medium mb-4">Obter chave gr√°tis (Groq)</a>
                        
                        <div className="text-left bg-stone-50 p-4 rounded-xl border border-stone-200 text-xs text-stone-600 leading-relaxed">
                            <p className="font-bold text-stone-800 mb-2">Tutorial R√°pido:</p>
                            <ol className="list-decimal pl-4 space-y-1">
                                <li>Acesse o site da Groq no link acima.</li>
                                <li>Fa√ßa login (Google/GitHub/Email).</li>
                                <li>No menu, toque em <strong>API Keys</strong>.</li>
                                <li>Toque em <strong>Create API Key</strong>.</li>
                                <li>Copie o c√≥digo <code>gsk_...</code> e cole aqui.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-[#fafaf9] overflow-hidden">
                    {/* Header Mobile */}
                    <header className="md:hidden h-16 bg-white border-b border-stone-200 flex items-center justify-between px-4 fixed top-0 left-0 right-0 z-40">
                         <div className="flex items-center gap-2">
                             <div className="w-8 h-8 bg-amber-900 text-white rounded-lg flex items-center justify-center"><Icon name="feather" size={16}/></div>
                             <span className="font-serif font-bold text-lg text-stone-900">BiblioScholar</span>
                         </div>
                         <button onClick={handleLogout} aria-label="Sair" className="text-stone-400 hover:text-red-500 p-2"><Icon name="log-out" size={20}/></button>
                    </header>

                    {/* Sidebar Desktop */}
                    <aside className="hidden md:flex w-72 bg-white border-r border-stone-200 flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
                        <div className="p-8 border-b border-stone-100 flex items-center gap-3">
                            <div className="w-8 h-8 bg-amber-900 text-white rounded-lg flex items-center justify-center shadow-md"><Icon name="feather" size={16} /></div>
                            <span className="font-serif font-bold text-xl text-stone-900 tracking-tight">BiblioScholar</span>
                        </div>
                        <nav className="p-4 space-y-1.5 flex-1 overflow-y-auto custom-scroll">
                            {[
                                {id:'home', l:'Painel', i:'layout-dashboard'},
                                {id:'bible', l:'B√≠blia', i:'book'},
                                {id:'chat', l:'Novo Estudo', i:'message-square-plus'},
                                {id:'history', l:'Hist√≥rico', i:'history'},
                                {id:'notes', l:'Anota√ß√µes', i:'notebook-pen'},
                                {id:'settings', l:'Ajustes', i:'settings'}
                            ].map(i => (
                                <button key={i.id} onClick={()=>i.id==='chat'?createNewSession():setTab(i.id)} className={`w-full flex gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${tab===i.id?'bg-amber-100 text-amber-900 shadow-md':'text-stone-600 hover:bg-stone-50 hover:text-stone-900'}`}>
                                    <Icon name={i.i} size={18}/> {i.l}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-stone-100 bg-stone-50/50">
                            <div className="flex items-center gap-3 px-2 mb-3">
                                <div className="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-600 font-bold text-xs shadow-inner">{user.username[0].toUpperCase()}</div>
                                <div className="overflow-hidden">
                                    <p className="text-sm font-bold text-stone-900 truncate">{user.username}</p>
                                    <p className="text-[10px] text-stone-500 truncate uppercase tracking-wider">{user.profile.level}</p>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="w-full flex items-center gap-2 px-2 py-2 text-xs text-stone-400 hover:text-red-600 transition-colors rounded-lg hover:bg-red-50">
                                <Icon name="log-out" size={14}/> Encerrar Sess√£o
                            </button>
                        </div>
                    </aside>

                    <main ref={mainRef} className="flex-1 h-full relative overflow-hidden bg-stone-50 pt-16 md:pt-0 transition-opacity duration-200">
                        {tab === 'home' && <HomeView user={user} onNavigate={(target, data, topic) => target==='daily'?startDaily():startPromptChat(data || '', topic)} />}
                        {tab === 'bible' && <BibleView user={user} fontSize={fontSize} currentTopic={currentTopic} onNavigate={(t,d) => startPromptChat(d)} />}
                        
                        {tab === 'chat' && currentSession && 
                            <ChatView 
                                key={currentSession.id}
                                user={user} 
                                apiKey={apiKey} 
                                promptInit={chatData} 
                                session={currentSession} 
                                onUpdateSession={updateSessionInRealTime} 
                            />}
                        {tab === 'history' && <HistoryView sessions={sessions} onSelectSession={loadSession} onDeleteSession={deleteSession} />}
                        {tab === 'notes' && <NotesView user={user} />}
                        {tab === 'settings' && <SettingsView user={user} fontSize={fontSize} onFontSizeChange={handleFontSizeChange} />}
                    </main>

                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-stone-200 flex justify-around p-2 pb-safe z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                        {[
                            {id:'home', i:'layout-dashboard', l:'Home'},
                            {id:'bible', i:'book', l:'B√≠blia'},
                            {id:'chat', i:'message-square-plus', l:'Novo'},
                            {id:'history', i:'history', l:'Hist.'},
                            {id:'notes', i:'notebook-pen', l:'Notas'},
                            {id:'settings', i:'settings', l:'Ajustes'}
                        ].map(i => (
                            <button key={i.id} onClick={()=>i.id==='chat'?createNewSession():setTab(i.id)} className={`flex flex-col items-center p-1 rounded-xl transition-all ${tab===i.id?'text-amber-900 bg-amber-50':'text-stone-400 active:scale-95'}`}>
                                <Icon name={i.i} size={20}/>
                                <span className="text-[10px] mt-1 font-medium">{i.l}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
